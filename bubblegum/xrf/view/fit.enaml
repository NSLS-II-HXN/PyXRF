# ######################################################################
# Copyright (c) 2014, Brookhaven Science Associates, Brookhaven        #
# National Laboratory. All rights reserved.                            #
#                                                                      #
# Redistribution and use in source and binary forms, with or without   #
# modification, are permitted provided that the following conditions   #
# are met:                                                             #
#                                                                      #
# * Redistributions of source code must retain the above copyright     #
#   notice, this list of conditions and the following disclaimer.      #
#                                                                      #
# * Redistributions in binary form must reproduce the above copyright  #
#   notice this list of conditions and the following disclaimer in     #
#   the documentation and/or other materials provided with the         #
#   distribution.                                                      #
#                                                                      #
# * Neither the name of the Brookhaven Science Associates, Brookhaven  #
#   National Laboratory nor the names of its contributors may be used  #
#   to endorse or promote products derived from this software without  #
#   specific prior written permission.                                 #
#                                                                      #
# THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS  #
# "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT    #
# LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS    #
# FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE       #
# COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT,           #
# INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES   #
# (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR   #
# SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)   #
# HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT,  #
# STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OTHERWISE) ARISING   #
# IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE   #
# POSSIBILITY OF SUCH DAMAGE.                                          #
########################################################################

import numpy as np

from enaml.widgets.api import (Container, PushButton, Label,
                               Form, Field, FileDialogEx, DockItem,
                               DockArea, CheckBox, ComboBox,
                               ScrollArea, Window)
from enaml.layout.api import hbox, vbox, HSplitLayout, VSplitLayout, spacer
from auto_enaml.api import AutoView
from enaml.stdlib.fields import FloatField


enamldef FitView(DockItem): fit_view:
    attr fileio_m
    attr param_m
    attr plot_m
    attr fit_m
    Container:
        constraints = [
            vbox(
                hbox(pb_param, spacer),
                hbox(param_status, spacer),
                lbl0,
                hbox(lbl1, cb1, spacer),
                hbox(lbl2, cb2, spacer),
                hbox(lbl3, cb3, spacer),
                hbox(pb_fit, pb_plot, spacer),
                hbox(btn_edit, spacer),
            ),
        ]
        #PushButton: pb1:
        #    text = 'Import Parameter Data'
        #    clicked ::
        #        fit_m.data = fileio_m.data
        #        fit_m.param_dict = param_m.param_d
        PushButton: pb_param:
            text = 'Import Parameter File'
            clicked ::
                param_path = FileDialogEx.get_open_file_name(fit_view)
                if param_path:
                    fit_m.file_path = param_path
                    param_status.text = fit_m.file_status
        Label: param_status:
            text = 'No file is loaded.'
        Label: lbl0:
            text = 'Fitting Strategy'
        Label: lbl1:
            text = 'Step 1'
        ComboBox: cb1:
            items = ['', 'fit_with_tail', 'free_more', 'e_calibration', 'linear']
            index = 0
            index >> fit_m.fit_strategy1
            #index ::
            #    print('use strategy 1: {}'.format(fit_m.fit_strategy1))
        Label: lbl2:
            text = 'Step 2'
        ComboBox: cb2:
            items = ['', 'fit_with_tail', 'free_more', 'e_calibration', 'linear']
            index = 0
            index >> fit_m.fit_strategy2
            #index ::
            #    print('use strategy 2: {}'.format(fit_m.fit_strategy2))
        Label: lbl3:
            text = 'Step 3'
        ComboBox: cb3:
            items = ['', 'fit_with_tail', 'free_more', 'e_calibration', 'linear']
            index = 0
            index >> fit_m.fit_strategy3
            #index ::
            #    print('use strategy 3: {}'.format(fit_m.fit_strategy3))
        PushButton: pb_fit:
            text = 'Fit'
            clicked ::
                #fit_m.fit_data()
                fit_m.fit_multiple()
                pb_plot.enabled = True
                plot_m.fit_x = fit_m.fit_x
                plot_m.fit_y = fit_m.fit_y
                plot_m.fit_all = fit_m.comps
                plot_m.plot_fit()
        PushButton: pb_plot:
            text = 'Overlap to Spectrum'
            checkable = True
            enabled = False
            clicked ::
                if checked:
                    plot_m.show_fit_opt = True
                    pb_plot.text = 'Remove Plot'
                else:
                    plot_m.show_fit_opt = False
                    pb_plot.text = 'Overlap to Spectrum'

        PushButton: btn_edit:
            text = 'Edit Defaults'
            clicked ::
                ParameterEdit.parameter_model = my_dict
                ParameterEdit().show()

my_dict ={
 "e_quadratic": {
        "adjust_element": "fixed",
        "bound_type": "lohi",
        "e_calibration": "fixed",
        "fit_with_tail": "lohi",
        "free_more": "lohi",
        "linear": "fixed",
        "max": 1e-06,
        "min": -1e-06,
        "value": 0.0
    },
    "fwhm_fanoprime": {
        "adjust_element": "fixed",
        "bound_type": "fixed",
        "e_calibration": "fixed",
        "fit_with_tail": "lohi",
        "free_more": "lohi",
        "linear": "fixed",
        "max": 0.0001,
        "min": 1e-07,
        "value": 1e-06
    },
    "fwhm_offset": {
        "adjust_element": "fixed",
        "bound_type": "lohi",
        "e_calibration": "fixed",
        "fit_with_tail": "lohi",
        "free_more": "lohi",
        "linear": "fixed",
        "max": 0.19,
        "min": 0.16,
        "value": 0.178
    }
}


enamldef ParameterEdit(Window):
    attr parameter_model
    destroy_on_close = False
    Container:
        ComboBox: cmb:
            items << sorted(parameter_model.keys())
            selected_item ::
                print(str(parameter_model[selected_item]))
                #fd1.value = parameter_model[selected_item]['value']
        FloatField: fd1:
            value = parameter_model[selected_item]['value']
        #AutoView: av:
        #    model = parameter_model.values()[0]
        #    initialized ::
        #        pass
        #        #for o in objects:
        #        #    o.label.tool_tip = str(o)
        PushButton: save:
            text = "Save changes to disk"
            clicked ::
                pass
                #save_defaults(parameter_model)
