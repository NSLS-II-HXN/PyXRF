language: python
sudo: false

env:
  global:
    # Doctr deploy key for NSLS-II/PyXRF
    - secure: "qyJw+saiOb9L9w/Fu+vg7sLI6kIHFN2Yhckuykl6wP24o0xBl2hjSa69uds6ClloAgxdm1eposkkRDsVrFaCY8PDzbxNLKAa64xbgzBxra8PXp/ZoyWfbkiDO4mC0aXtlxY4IHcHyqJSRcgILZomzkIJJKP/xZZEH8t5BdIiOv2NS6oOifVaWt1zF4ug05jsU3ni5/Zy1KHwTSLG1WIFrhZrFJrMmS9nQTwGIio8cTInhOK6/Vhvi+Zp4ik+aeIbzx8cDF3FGbYx2PD1axVWM7049MbtYEcGL9Der6E4h2doT/xERahJXd50sadrHEyGMy41VI7kwVCs/Y5HEzEi1INYmmaL0JbTqXG3UcJWab2EeKwlEn7i6QqE3ZRcZGYgVXumENjBZNCcuBc87sCMwCVSRGahIFWHWYoyq/0sIw+y5gHW7UcT1ivqhDDuqQ2ZWJ8Y8KwroylwpOqS6tvJ5rGQCZg4OMoR07yQ/v6Kj+Hl+5Z97aLhnuhFF1VJjOuqaJ/nLKp7otBg7MQnfHIhMWh+4SDDlOGLBpHXTCBaCSOCGolSKJJg2A/5cUM+1Tdt1xRFC/oWdgnIGqLlOFYwPq5Rkd9BrhSdFZXOeD9wTFmoUqHce0htCDRIZfxcNwWzjuahqvGQbGBgi1h8bOYFFn9VNxD6vVjwV4usJElPPkc="
    - BUILD_DOCS: false
    - GH_REF: github.com/NSLS-II/PyXRF.git

cache:
  directories:
    - $HOME/.cache/pip
    - $HOME/.ccache

matrix:
  fast_finish: true
  include:
    - python: 3.7
      env: BUILD_DOCS=true SUBMIT_CODECOV=true NUMPY=1.17
    - os: osx
      language: generic
      env: TRAVIS_PYTHON_VERSION=3.6 NUMPY=1.17
    - os: osx
      language: generic
      env: TRAVIS_PYTHON_VERSION=3.7 NUMPY=1.17

python:
  - 3.6
  - 3.7

env:
  - NUMPY=1.17

before_install:
  - |
    set -e
    if [ "$TRAVIS_OS_NAME" == "linux" ]; then
        arch="Linux"
    elif [ "$TRAVIS_OS_NAME" == "osx" ]; then
        arch="MacOSX"
    else
        echo "Unknown arch $TRAVIS_OS_NAME"
        exit 1
    fi
    wget https://repo.continuum.io/miniconda/Miniconda3-latest-${arch}-x86_64.sh -O miniconda.sh
    chmod +x miniconda.sh
    ./miniconda.sh -b -p ~/mc
    source ~/mc/etc/profile.d/conda.sh
    conda update conda --yes
    export CONDARC=ci/condarc

install:
  - export GIT_FULL_HASH=`git rev-parse HEAD`
  - conda create -y -n testenv python=$TRAVIS_PYTHON_VERSION numpy=$NUMPY
  - conda activate testenv
  - conda install -y scikit-beam -c nsls2forge
  - pip install -r requirements.txt
  - pip install -r requirements-dev.txt
  - pip install codecov
  - pip install .
  - conda list
  - pip list

script:
- python -c "import platform; import os; ver_installed = platform.python_version();
  ver_requested = os.environ['TRAVIS_PYTHON_VERSION'];
  assert ver_installed.startswith(f'{ver_requested}.');"
- python -c "import numpy; import os; ver_installed = numpy.__version__;
  ver_requested = os.environ['NUMPY'];
  assert ver_installed.startswith(f'{ver_requested}.')"
- flake8
- coverage run run_tests.py
- coverage report -m
- |
  set -e  # If any of the following steps fail, just stop at that point.
  if [ $BUILD_DOCS == 'true' ]; then
    pip install -r requirements-docs.txt
    make -C docs html  # Build the documentation.
    doctr deploy --built-docs docs/_build/html .  # Publish the documentation.
  fi

after_success:
  #- if [ $SUBMIT_CODECOV == 'true' ]; then codecov; fi;
